<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SHIB Ads WebApp</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap'); 

        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Vazirmatn', Arial, Helvetica, sans-serif;overflow:hidden;background: #0d0c1d; color: #fff;}
        
        /* -------------------------------------- */
        /* Core Screen Management */
        /* -------------------------------------- */
        .app-screen {
            position: fixed;
            inset: 0;
            background: url('img.png') no-repeat center center;
            background-size: cover;
            transition: opacity .5s ease-in;
            display: flex;
            flex-direction: column;
            opacity: 0;
            pointer-events: none; 
            z-index: 10; 
        }
        .app-screen.visible {
            opacity: 1;
            pointer-events: auto;
            z-index: 20; 
        }
        .content {
            flex-grow: 1;
            overflow-y: auto;
            padding: 20px;
            padding-bottom: 80px; /* Space for the bottom nav */
        }
        
        /* Loading Screen - Neon enhancements */
        .loading-screen{
            position:fixed;
            inset:0;
            background:#000;
            z-index:999;
            display:flex;
            flex-direction:column;
            justify-content:center;
            align-items:center;
            transition:opacity .5s ease-out;
        }
        .loading-text{
            font-family:'Orbitron', sans-serif;
            font-size:24px;
            color:#fff;
            text-shadow:0 0 5px #0ff, 0 0 10px #0ff, 0 0 20px #0ff;
            animation:flicker 1.5s infinite alternate;
        }
        @keyframes flicker{
            0%,100%{opacity:1;text-shadow:0 0 5px #0ff,0 0 10px #0ff,0 0 20px #0ff}
            50%{opacity:.7;text-shadow:none}
        }
        .spinner{
            width:40px;
            height:40px;
            border:4px solid rgba(255,255,255,.3);
            border-top-color:#0ff;
            border-radius:50%;
            animation:spin 1s ease-in-out infinite;
            margin-top:15px;
        }
        @keyframes spin{
            to{transform:rotate(360deg)}
        }

        /* Header */
        .header {
            background: rgba(13, 12, 29, 0.8); /* Semi-transparent background */
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(0, 255, 255, 0.3);
            box-shadow: 0 2px 10px rgba(0, 255, 255, 0.1);
        }
        .balance-container {
            text-align: right;
            font-family: 'Orbitron', sans-serif;
            line-height: 1.2;
        }
        .balance-title {
            font-size: 12px;
            color: #ccc;
        }
        .balance-value {
            font-size: 24px;
            color: #0ff;
            text-shadow: 0 0 5px #0ff;
        }
        .balance-value.shib {
            font-size: 16px;
            color: #ff9900; /* Shiba-like color */
        }
        
        /* Navigation (Bottom Bar) */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(13, 12, 29, 0.9);
            border-top: 1px solid rgba(0, 255, 255, 0.3);
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            box-shadow: 0 -2px 10px rgba(0, 255, 255, 0.2);
            z-index: 30;
        }
        .nav-button {
            background: none;
            border: none;
            color: #888;
            padding: 5px;
            cursor: pointer;
            transition: color 0.3s, transform 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 10px;
        }
        .nav-button:hover, .nav-button.active {
            color: #0ff;
            text-shadow: 0 0 5px #0ff;
        }
        .nav-button i {
            font-size: 20px;
            margin-bottom: 3px;
        }

        /* -------------------------------------- */
        /* Home Screen */
        /* -------------------------------------- */
        .action-cards-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
        }
        .action-card {
            background: rgba(0, 255, 255, 0.05);
            border: 1px solid rgba(0, 255, 255, 0.2);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            transition: background 0.3s, transform 0.2s;
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.1);
            position: relative;
        }
        .action-card:hover {
            background: rgba(0, 255, 255, 0.1);
            transform: translateY(-3px);
        }
        .card-icon {
            font-size: 30px;
            color: #ff9900;
            margin-bottom: 10px;
        }
        .card-title {
            font-size: 14px;
            font-weight: bold;
            color: #0ff;
            margin-bottom: 5px;
            font-family: 'Orbitron', sans-serif;
        }
        .card-limit {
            font-size: 12px;
            color: #ccc;
        }
        .card-reward {
             font-size: 12px;
             color: #ffcc00;
             margin-top: 5px;
        }
        .limit-reached-overlay {
            position: absolute;
            inset: 0;
            background: rgba(255, 0, 0, 0.7);
            border-radius: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #fff;
            font-weight: bold;
            font-size: 16px;
            text-shadow: 0 0 5px #000;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .action-card.disabled .limit-reached-overlay {
            opacity: 1;
        }

        /* -------------------------------------- */
        /* Spin Screen */
        /* -------------------------------------- */
        .wheel-container {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 20px;
        }
        .wheel-wrapper {
            position: relative;
            width: 90vmin;
            height: 90vmin;
            max-width: 300px;
            max-height: 300px;
            margin-bottom: 20px;
            background: #2a2a44;
            border-radius: 50%;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.5);
            border: 5px solid #0ff;
        }
        .wheel {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            position: relative;
            transition: transform 5s cubic-bezier(0.25, 0.1, 0.25, 1);
            overflow: hidden;
        }
        .wheel-center {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 50px;
            height: 50px;
            background: #ff9900;
            border: 3px solid #fff;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            z-index: 10;
            box-shadow: 0 0 10px #ff9900;
        }
        .sector {
            position: absolute;
            top: 0;
            right: 0;
            width: 50%;
            height: 50%;
            transform-origin: 0% 100%;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .sector-inner {
            position: absolute;
            left: -100%;
            top: -100%;
            width: 200%;
            height: 200%;
            transform: rotate(calc(90deg + var(--rotation) * 1deg)) skewY(calc(90deg - var(--angle) * 1deg));
            background: var(--color);
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .sector-text {
            position: absolute;
            transform: rotate(calc(90deg / var(--sectors) + var(--text-rotation) * 1deg)) translate(35%, 0);
            color: #000;
            font-size: 16px;
            font-weight: bold;
            font-family: 'Orbitron', sans-serif;
            z-index: 2;
        }
        .pointer {
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-bottom: 20px solid #f00;
            z-index: 15;
            filter: drop-shadow(0 0 5px #f00);
        }
        .spin-button {
            padding: 15px 30px;
            background: linear-gradient(45deg, #ff9900, #ffcc00);
            color: #0d0c1d;
            border: none;
            border-radius: 50px;
            font-family: 'Orbitron', sans-serif;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 0 20px rgba(255, 153, 0, 0.7);
            transition: background 0.3s, transform 0.1s, box-shadow 0.3s;
            margin-top: 20px;
        }
        .spin-button:disabled {
            background: #444;
            color: #999;
            box-shadow: none;
            cursor: not-allowed;
        }
        .spin-button:active:not(:disabled) {
            transform: scale(0.98);
        }
        .spin-message {
            margin-top: 15px;
            font-size: 14px;
            color: #0ff;
            text-shadow: 0 0 5px rgba(0, 255, 255, 0.5);
        }
        /* -------------------------------------- */
        /* Withdrawal Screen */
        /* -------------------------------------- */
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
            color: #0ff;
            font-family: 'Orbitron', sans-serif;
        }
        .form-group input {
            width: 100%;
            padding: 10px;
            background: rgba(0, 255, 255, 0.1);
            border: 1px solid #0ff;
            border-radius: 5px;
            color: #fff;
            font-size: 16px;
            box-shadow: 0 0 5px rgba(0, 255, 255, 0.3) inset;
        }
        .form-group input::placeholder {
            color: #aaa;
        }
        .withdraw-button {
            width: 100%;
            padding: 15px;
            background: linear-gradient(90deg, #ff00ff, #00ffff);
            color: #fff;
            border: none;
            border-radius: 5px;
            font-family: 'Orbitron', sans-serif;
            font-size: 18px;
            cursor: pointer;
            box-shadow: 0 0 15px rgba(255, 0, 255, 0.5), 0 0 15px rgba(0, 255, 255, 0.5);
            transition: opacity 0.3s;
        }
        .withdraw-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            box-shadow: none;
        }
        .withdraw-note {
            margin-top: 20px;
            font-size: 12px;
            color: #ff9900;
            text-align: center;
        }
        .withdrawal-history-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 18px;
            color: #0ff;
            margin-top: 30px;
            margin-bottom: 10px;
            border-bottom: 1px solid rgba(0, 255, 255, 0.3);
            padding-bottom: 5px;
        }
        .withdrawal-list {
            list-style: none;
            padding: 0;
        }
        .withdrawal-item {
            background: rgba(0, 255, 255, 0.05);
            border: 1px solid rgba(0, 255, 255, 0.1);
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
        }
        .withdrawal-item .status {
            font-weight: bold;
        }
        .withdrawal-item .pending {
            color: #ffcc00;
        }
        .withdrawal-item .completed {
            color: #0f0;
        }
        .withdrawal-item .failed {
            color: #f00;
        }
        .no-history {
            color: #aaa;
            text-align: center;
            padding: 20px;
        }

        /* -------------------------------------- */
        /* Referral Screen */
        /* -------------------------------------- */
        .referral-info {
            background: rgba(255, 153, 0, 0.05);
            border: 1px solid rgba(255, 153, 0, 0.3);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
        }
        .referral-count {
            font-size: 36px;
            font-family: 'Orbitron', sans-serif;
            color: #ff9900;
            text-shadow: 0 0 10px rgba(255, 153, 0, 0.5);
            margin-bottom: 10px;
        }
        .referral-link-box {
            background: #1a1a33;
            border: 1px dashed #0ff;
            padding: 10px;
            border-radius: 5px;
            word-break: break-all;
            margin-bottom: 15px;
            font-size: 14px;
            color: #0ff;
        }
        .copy-button {
            padding: 10px 20px;
            background: #0ff;
            color: #0d0c1d;
            border: none;
            border-radius: 5px;
            font-family: 'Vazirmatn', sans-serif;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.2s;
        }
        .copy-button:hover {
            background: #fff;
        }
        .commission-rate {
            font-size: 14px;
            color: #ccc;
            margin-top: 15px;
        }

        /* -------------------------------------- */
        /* Task Screen ⬅️ (تحسين التصميم هنا) */
        /* -------------------------------------- */
        .task-list {
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .task-card {
            background: rgba(0, 255, 255, 0.08); /* Darker, more prominent background */
            border: 1px solid rgba(0, 255, 255, 0.3);
            border-radius: 15px; /* More rounded corners */
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.1);
        }
        .task-info {
            flex-grow: 1;
            margin-right: 15px;
        }
        .task-title {
            font-size: 16px;
            font-weight: bold;
            color: #ff9900; /* Shiba color for prominence */
            margin-bottom: 5px;
        }
        .task-description {
            font-size: 12px;
            color: #ccc;
            margin-bottom: 8px;
        }
        .task-reward {
            font-size: 14px;
            font-family: 'Orbitron', sans-serif;
            color: #0ff;
            text-shadow: 0 0 5px #0ff;
        }
        .task-action-button {
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            font-family: 'Vazirmatn', sans-serif;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            min-width: 100px;
        }

        /* Active Button Style (Not Completed) */
        .task-action-button.active-task {
            background: linear-gradient(45deg, #ff00ff, #00ffff);
            color: #fff;
            box-shadow: 0 0 10px rgba(255, 0, 255, 0.6), 0 0 10px rgba(0, 255, 255, 0.6);
        }
        .task-action-button.active-task:hover {
            transform: scale(1.05);
        }

        /* Completed Button Style */
        .task-action-button.completed-task {
            background: #222;
            color: #0f0;
            border: 1px solid #0f0;
            box-shadow: 0 0 5px rgba(0, 255, 0, 0.5);
            cursor: default;
        }
        .task-action-button.completed-task:hover {
            transform: none;
        }
        .task-screen .header-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 20px;
            color: #fff;
            text-shadow: 0 0 10px #0ff;
            text-align: center;
            margin-bottom: 20px;
        }


        /* -------------------------------------- */
        /* Custom Alert */
        /* -------------------------------------- */
        .custom-alert-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }
        .custom-alert-overlay.visible {
            opacity: 1;
            pointer-events: auto;
        }
        .custom-alert {
            background: #1a1a33;
            border-radius: 15px;
            padding: 25px;
            width: 90%;
            max-width: 350px;
            text-align: center;
            box-shadow: 0 0 30px rgba(0, 255, 255, 0.5);
            transform: scale(0.9);
            transition: transform 0.3s ease-out;
            position: relative;
        }
        .custom-alert-overlay.visible .custom-alert {
            transform: scale(1);
        }
        .alert-icon {
            font-size: 40px;
            margin-bottom: 15px;
        }
        .alert-icon.success {
            color: #0f0;
        }
        .alert-icon.error {
            color: #f00;
        }
        .alert-icon.info {
            color: #ffcc00;
        }
        .alert-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 20px;
            margin-bottom: 10px;
        }
        .alert-message {
            font-size: 14px;
            color: #ccc;
            white-space: pre-wrap;
            margin-bottom: 20px;
        }
        .alert-close-button {
            padding: 10px 25px;
            background: #0ff;
            color: #0d0c1d;
            border: none;
            border-radius: 5px;
            font-family: 'Vazirmatn', sans-serif;
            font-weight: bold;
            cursor: pointer;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
</head>
<body>
    
    <div class="loading-screen" id="loading-screen">
        <div class="loading-text">LOADING SHIB NET...</div>
        <div class="spinner"></div>
    </div>
    
    <div class="custom-alert-overlay" id="custom-alert-overlay">
        <div class="custom-alert" id="custom-alert">
            <div class="alert-icon" id="alert-icon"></div>
            <div class="alert-title" id="alert-title"></div>
            <div class="alert-message" id="alert-message"></div>
            <button class="alert-close-button" id="alert-close-button">OK</button>
        </div>
    </div>

    <div class="app-screen visible" id="home-screen">
        <div class="header">
            <div class="user-info">
                <span class="balance-title">User ID:</span>
                <div class="balance-value shib" id="display-user-id">...</div>
            </div>
            <div class="balance-container">
                <span class="balance-title">Balance (SHIB)</span>
                <div class="balance-value" id="display-balance">0</div>
            </div>
        </div>
        <div class="content">
            <h2 style="font-family: 'Orbitron', sans-serif; margin-bottom: 20px; color: #fff;">ACTION CENTER</h2>
            
            <div class="action-cards-container">
                <div class="action-card" id="card-watch-ad">
                    <i class="card-icon fas fa-video"></i>
                    <div class="card-title">WATCH AD</div>
                    <div class="card-reward">+<span id="ad-reward-value">3</span> SHIB</div>
                    <div class="card-limit">Limit: <span id="ads-watched">0</span>/<span id="ads-limit">100</span></div>
                    <div class="limit-reached-overlay" id="ad-limit-overlay">LIMIT REACHED</div>
                </div>

                <div class="action-card" id="card-spin-wheel">
                    <i class="card-icon fas fa-circle-notch"></i>
                    <div class="card-title">SPIN & WIN</div>
                    <div class="card-reward">Up to <span id="spin-max-reward">20</span> SHIB</div>
                    <div class="card-limit">Limit: <span id="spins-used">0</span>/<span id="spins-limit">15</span></div>
                    <div class="limit-reached-overlay" id="spin-limit-overlay">LIMIT REACHED</div>
                </div>
            </div>
        </div>
    </div>

    <div class="app-screen" id="spin-screen">
        <div class="header">
            <div class="balance-container" style="margin-left: auto;">
                <span class="balance-title">Balance (SHIB)</span>
                <div class="balance-value" id="display-balance-spin">0</div>
            </div>
        </div>
        <div class="content">
            <div class="wheel-container">
                <h2 style="font-family: 'Orbitron', sans-serif; color: #fff; margin-bottom: 10px;">LUCKY SPIN</h2>
                <div class="spin-message" id="spin-limit-message">Spins Left: 15</div>
                
                <div class="wheel-wrapper">
                    <div class="wheel" id="spin-wheel">
                        <div class="wheel-center"></div>
                    </div>
                    <div class="pointer"></div>
                </div>
                
                <button class="spin-button" id="spin-button">SPIN</button>
            </div>
        </div>
    </div>

    <div class="app-screen" id="withdraw-screen">
        <div class="header">
            <div class="balance-container" style="margin-left: auto;">
                <span class="balance-title">Balance (SHIB)</span>
                <div class="balance-value" id="display-balance-withdraw">0</div>
            </div>
        </div>
        <div class="content">
            <h2 style="font-family: 'Orbitron', sans-serif; color: #fff; margin-bottom: 20px; text-align: center;">WITHDRAWAL</h2>

            <form id="withdraw-form">
                <div class="form-group">
                    <label for="binance-id">Binance Pay ID / Email / Phone</label>
                    <input type="text" id="binance-id" required placeholder="Enter your Binance Pay ID or Email">
                </div>
                <div class="form-group">
                    <label for="withdraw-amount">Amount (Min: 400 SHIB)</label>
                    <input type="number" id="withdraw-amount" required min="400" placeholder="Enter amount">
                </div>
                <button type="submit" class="withdraw-button" id="submit-withdraw">WITHDRAW</button>
            </form>

            <p class="withdraw-note">All withdrawal requests are processed manually within 24 hours.</p>

            <h3 class="withdrawal-history-title">History</h3>
            <ul class="withdrawal-list" id="withdrawal-history-list">
                </ul>
        </div>
    </div>

    <div class="app-screen" id="referral-screen">
        <div class="header">
            <div class="balance-container" style="margin-left: auto;">
                <span class="balance-title">Balance (SHIB)</span>
                <div class="balance-value" id="display-balance-referral">0</div>
            </div>
        </div>
        <div class="content">
            <h2 style="font-family: 'Orbitron', sans-serif; color: #fff; margin-bottom: 20px; text-align: center;">REFERRALS</h2>

            <div class="referral-info">
                <p style="color: #ccc; margin-bottom: 10px;">Total Referrals:</p>
                <div class="referral-count" id="referrals-count">0</div>
                <p class="commission-rate">Earn **5%** commission on all earnings by your referrals.</p>
            </div>

            <h3 style="font-family: 'Orbitron', sans-serif; color: #0ff; margin-bottom: 10px;">Your Link</h3>
            <div class="referral-link-box" id="referral-link">Loading...</div>
            <button class="copy-button" id="copy-referral-link">COPY LINK</button>

            <p style="margin-top: 20px; color: #aaa; font-size: 12px; text-align: center;">Share this link to grow your network and increase your passive income.</p>
        </div>
    </div>

    <div class="app-screen" id="task-screen">
        <div class="header">
            <div class="balance-container" style="margin-left: auto;">
                <span class="balance-title">Balance (SHIB)</span>
                <div class="balance-value" id="display-balance-task">0</div>
            </div>
        </div>
        <div class="content">
            <div class="header-title">ONE-TIME TASKS</div>
            
            <div class="task-list">
                <div class="task-card" id="task-join-telegram">
                    <div class="task-info">
                        <div class="task-title">JOIN TELEGRAM CHANNEL</div>
                        <div class="task-description">Join our official channel to get news and updates.</div>
                        <div class="task-reward">+50 SHIB (One-Time)</div>
                    </div>
                    <button class="task-action-button active-task" id="button-join-telegram" data-task-id="joinTelegram">
                        JOIN & CLAIM
                    </button>
                </div>
                
                <p style="margin-top: 30px; color: #aaa; text-align: center;">More tasks coming soon!</p>
            </div>
        </div>
    </div>
    
    <div class="bottom-nav">
        <button class="nav-button active" data-screen="home-screen">
            <i class="fas fa-home"></i>
            <span>Home</span>
        </button>
        <button class="nav-button" data-screen="spin-screen">
            <i class="fas fa-circle-notch"></i>
            <span>Spin</span>
        </button>
        <button class="nav-button" data-screen="task-screen">
            <i class="fas fa-tasks"></i>
            <span>Task</span>
        </button>
        <button class="nav-button" data-screen="referral-screen">
            <i class="fas fa-users"></i>
            <span>Referral</span>
        </button>
        <button class="nav-button" data-screen="withdraw-screen">
            <i class="fas fa-wallet"></i>
            <span>Withdraw</span>
        </button>
    </div>

    <audio id="bg-audio" loop>
        <source src="background-music.mp3" type="audio/mpeg">
    </audio>

    <script>
        // Global State Management
        let appState = {
            balance: 0,
            ads_watched_today: 0,
            spins_today: 0,
            ads_limit_reached_at: null,
            spins_limit_reached_at: null,
            referrals_count: 0,
            withdrawal_history: [],
            is_banned: false,
            task_completed: false, // ⬅️ NEW STATE
            user_id: null,
        };

        const DAILY_MAX_ADS = 100;
        const DAILY_MAX_SPINS = 15;
        const AD_REWARD = 3;
        const MIN_WITHDRAW = 400;

        // Configuration
        const API_URL = '/api'; 
        const BOT_USERNAME = 'ShibAdsBot'; // Replace with your actual bot username
        const TELEGRAM_CHANNEL_URL = 'https://t.me/botbababab'; // ⬅️ Task Channel

        // DOM Elements
        const screens = document.querySelectorAll('.app-screen');
        const navButtons = document.querySelectorAll('.bottom-nav .nav-button');
        const loadingScreen = document.getElementById('loading-screen');
        const adCard = document.getElementById('card-watch-ad');
        const spinCard = document.getElementById('card-spin-wheel');

        // Spin Wheel DOM
        const spinWheelElement = document.getElementById('spin-wheel');
        const spinButton = document.getElementById('spin-button');
        const spinMessage = document.getElementById('spin-limit-message');

        // Task DOM
        const joinTelegramTaskCard = document.getElementById('task-join-telegram');
        const joinTelegramButton = document.getElementById('button-join-telegram');
        
        // Withdrawal DOM
        const withdrawForm = document.getElementById('withdraw-form');
        const withdrawalHistoryList = document.getElementById('withdrawal-history-list');

        // Audio
        const bgAudio = document.getElementById('bg-audio');
        function playBGAudio() {
            if (bgAudio.paused) {
                bgAudio.volume = 0.3;
                bgAudio.play().catch(e => console.warn("Audio Play failed:", e));
            }
        }

        // --- Core Functions ---

        /**
         * Fetches data from the server API.
         */
        async function fetchApi(payload) {
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ...payload, initData: window.Telegram.WebApp.initData })
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ error: `Server error: ${response.status}` }));
                    throw new Error(errorData.error || errorData.message || `HTTP error! Status: ${response.status}`);
                }

                return await response.json();

            } catch (error) {
                console.error('API Call Failed:', error.message);
                showCustomAlert('Error', error.message, 'error');
                return { ok: false, error: error.message };
            }
        }
        
        /**
         * Switches the visible screen and updates the navigation bar.
         */
        function switchScreen(targetId) {
            screens.forEach(screen => {
                screen.classList.remove('visible');
                if (screen.id === targetId) {
                    screen.classList.add('visible');
                }
            });
            navButtons.forEach(btn => {
                btn.classList.remove('active');
                if (btn.getAttribute('data-screen') === targetId) {
                    btn.classList.add('active');
                }
            });
            // Update balance displays for the active screen
            updateUI(); 
        }

        /**
         * Updates the global app state and refreshes the UI.
         */
        function updateState(newState) {
            appState = { ...appState, ...newState };
            updateUI();
        }

        /**
         * Central function to update all dynamic UI elements.
         */
        function updateUI() {
            const { balance, ads_watched_today, spins_today, referrals_count, task_completed } = appState;
            
            // 1. Balance Displays
            const balanceDisplays = document.querySelectorAll('.balance-value');
            balanceDisplays.forEach(el => {
                if (el.id.includes('balance')) {
                   el.textContent = balance.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                }
            });

            // 2. Home Screen Cards (Ads)
            document.getElementById('ads-watched').textContent = ads_watched_today;
            document.getElementById('ads-limit').textContent = DAILY_MAX_ADS;
            const isAdLimitReached = ads_watched_today >= DAILY_MAX_ADS;
            adCard.classList.toggle('disabled', isAdLimitReached);
            adCard.style.cursor = isAdLimitReached ? 'default' : 'pointer';

            // 3. Home Screen Cards (Spin)
            document.getElementById('spins-used').textContent = spins_today;
            document.getElementById('spins-limit').textContent = DAILY_MAX_SPINS;
            const isSpinLimitReached = spins_today >= DAILY_MAX_SPINS;
            spinCard.classList.toggle('disabled', isSpinLimitReached);
            spinCard.style.cursor = isSpinLimitReached ? 'default' : 'pointer';
            
            // Spin Screen
            spinMessage.textContent = `Spins Left: ${DAILY_MAX_SPINS - spins_today}`;
            spinButton.disabled = isSpinLimitReached;

            // 4. Referral Screen
            document.getElementById('referrals-count').textContent = referrals_count;
            
            // 5. Withdrawal Screen
            document.getElementById('withdraw-amount').max = Math.floor(balance);
            document.getElementById('submit-withdraw').disabled = balance < MIN_WITHDRAW;

            // 6. Task Screen ⬅️ NEW UI UPDATE
            updateTaskUI(task_completed);
        }
        
        /**
         * Updates the Task UI based on completion status.
         */
        function updateTaskUI(isCompleted) {
            if (isCompleted) {
                joinTelegramButton.textContent = 'COMPLETED';
                joinTelegramButton.classList.remove('active-task');
                joinTelegramButton.classList.add('completed-task');
                joinTelegramButton.disabled = true;
            } else {
                joinTelegramButton.textContent = 'JOIN & CLAIM';
                joinTelegramButton.classList.remove('completed-task');
                joinTelegramButton.classList.add('active-task');
                joinTelegramButton.disabled = false;
            }
        }
        
        /**
         * Displays the withdrawal history list.
         */
        function displayWithdrawals() {
            const history = appState.withdrawal_history;
            withdrawalHistoryList.innerHTML = '';
            
            if (history.length === 0) {
                withdrawalHistoryList.innerHTML = '<li class="no-history">No withdrawal history yet.</li>';
                return;
            }

            history.forEach(item => {
                const li = document.createElement('li');
                li.className = 'withdrawal-item';
                
                const statusClass = item.status === 'pending' ? 'pending' : (item.status === 'completed' ? 'completed' : 'failed');
                
                li.innerHTML = `
                    <span>${new Date(item.created_at).toLocaleDateString()}</span>
                    <span>${parseFloat(item.amount).toLocaleString()} SHIB</span>
                    <span class="status ${statusClass}">${item.status.toUpperCase()}</span>
                `;
                withdrawalHistoryList.appendChild(li);
            });
        }
        
        // --- Security Action ID Handling ---
        
        /**
         * Requests and returns a single-use action ID from the server.
         */
        async function requestActionId(actionType) {
            try {
                const result = await fetchApi({ type: 'generateActionId', action_type: actionType });
                if (result.ok && result.data.action_id) {
                    return result.data.action_id;
                }
                showCustomAlert('Error', 'Failed to get server token.', 'error');
                return null;
            } catch (error) {
                return null;
            }
        }

        // --- Data Initialization ---

        /**
         * Registers a new user or loads initial data.
         */
        async function loadUserData() {
            const { user } = window.Telegram.WebApp.initDataUnsafe;
            if (!user) {
                showCustomAlert('Error', 'User data not found in Telegram initData.', 'error');
                return;
            }

            appState.user_id = user.id;
            document.getElementById('display-user-id').textContent = user.id;

            // Step 1: Register or ensure user exists
            const urlParams = new URLSearchParams(window.location.search);
            const refBy = urlParams.get('start') ? parseInt(urlParams.get('start')) : null;

            await fetchApi({
                type: 'register',
                user_id: user.id,
                ref_by: refBy // Only sends ref_by if it's a valid ID from the start parameter
            });
            
            // Step 2: Fetch user data
            const result = await fetchApi({ type: 'getUserData', user_id: user.id });

            if (result.ok) {
                // If banned, show alert and lock UI
                if (result.data.is_banned) {
                    showCustomAlert('BANNED', 'Your account has been permanently banned.', 'error', () => {
                        document.body.innerHTML = '<div style="color:red; text-align:center; padding-top:100px;">ACCOUNT BANNED</div>';
                    });
                    return;
                }
                
                // Update global state
                updateState(result.data);
                
                // Set Referral Link
                document.getElementById('referral-link').textContent = `https://t.me/${BOT_USERNAME}?start=${user.id}`;
                
                // Display History
                displayWithdrawals();

                // Hide Loading Screen
                setTimeout(() => {
                    loadingScreen.style.opacity = '0';
                    loadingScreen.addEventListener('transitionend', () => loadingScreen.style.display = 'none');
                }, 500);

            } else {
                showCustomAlert('Error', 'Failed to load user data.', 'error');
            }
        }
        
        // --- Custom Alert Implementation ---
        
        const alertOverlay = document.getElementById('custom-alert-overlay');
        const alertIcon = document.getElementById('alert-icon');
        const alertTitle = document.getElementById('alert-title');
        const alertMessage = document.getElementById('alert-message');
        const alertCloseButton = document.getElementById('alert-close-button');

        function showCustomAlert(title, message, type = 'info', onCloseCallback = null) {
            alertTitle.textContent = title;
            alertMessage.textContent = message;

            alertIcon.className = 'alert-icon'; // Reset classes
            if (type === 'success') {
                alertIcon.classList.add('fas', 'fa-check-circle', 'success');
            } else if (type === 'error') {
                alertIcon.classList.add('fas', 'fa-times-circle', 'error');
            } else {
                alertIcon.classList.add('fas', 'fa-info-circle', 'info');
            }
            
            const closeHandler = () => {
                alertOverlay.classList.remove('visible');
                alertCloseButton.removeEventListener('click', closeHandler);
                if (onCloseCallback) {
                    onCloseCallback();
                }
            };

            alertCloseButton.addEventListener('click', closeHandler);
            alertOverlay.classList.add('visible');
        }

        // --- Event Handlers ---

        // Navigation
        navButtons.forEach(button => {
            button.addEventListener('click', () => {
                const targetScreen = button.getAttribute('data-screen');
                switchScreen(targetScreen);
            });
        });
        
        // Watch Ad
        adCard.addEventListener('click', async () => {
            if (adCard.classList.contains('disabled')) return;
            
            // 1. Get Action ID from the Server
            const actionId = await requestActionId('watchAd');
            if (!actionId) return;

            // 2. Simulate the Ad Watch delay (e.g., 3 seconds minimum)
            // Telegram.WebApp.showAlert('Ad started. Please wait...'); 
            // await new Promise(resolve => setTimeout(resolve, 3000));
            
            // 3. Send server request
            const result = await fetchApi({
                type: 'watchAd',
                user_id: appState.user_id,
                action_id: actionId 
            });

            if (result.ok) {
                // 4. Update state and UI with trusted server values
                updateState({ 
                    balance: result.data.new_balance, 
                    ads_watched_today: result.data.new_ads_count 
                });
                showCustomAlert('Success!', `You earned ${result.data.actual_reward} SHIB.`, 'success');
            } else {
                 showCustomAlert('Ad Error', result.error || 'Failed to claim reward.', 'error');
            }
        });

        // Spin Logic
        
        // Configuration for the wheel sectors (prize, color)
        const SPIN_SECTORS_CONFIG = [
            { prize: 5, color: '#ff00ff' }, // Magenta
            { prize: 10, color: '#00ffff' }, // Cyan
            { prize: 15, color: '#ff9900' }, // Orange
            { prize: 20, color: '#0f0' }, // Green
            { prize: 5, color: '#ff00ff' }  // Magenta (repeated for 5 sectors)
        ];
        const SECTORS_COUNT = SPIN_SECTORS_CONFIG.length;
        const SEGMENT_ANGLE = 360 / SECTORS_COUNT;
        
        function createWheel() {
            spinWheelElement.innerHTML = '';
            SPIN_SECTORS_CONFIG.forEach((sector, index) => {
                const element = document.createElement('div');
                element.className = 'sector';
                
                // CSS variable for rotation
                const rotation = index * SEGMENT_ANGLE;
                element.style.setProperty('--rotation', rotation);
                
                // Skew calculation (90deg - (360/N)/2)
                const skewAngle = 90 - (SEGMENT_ANGLE / 2);

                element.innerHTML = `
                    <div class="sector-inner" style="--color: ${sector.color}; --angle: ${SEGMENT_ANGLE};">
                        <span class="sector-text" style="--sectors: ${SECTORS_COUNT}; --text-rotation: ${rotation};">
                            ${sector.prize}
                        </span>
                    </div>
                `;
                spinWheelElement.appendChild(element);
            });
            
            // Add Center
            const center = document.createElement('div');
            center.className = 'wheel-center';
            spinWheelElement.appendChild(center);
            
            // Add Pointer
            const pointer = document.createElement('div');
            pointer.className = 'pointer';
            spinWheelElement.appendChild(pointer);
        }
        
        // Initial wheel creation
        createWheel();

        spinButton.addEventListener('click', async () => {
            if (spinButton.disabled) return;
            
            // 1. Get Action ID for preSpin (Security Check before spinning)
            const preSpinActionId = await requestActionId('preSpin');
            if (!preSpinActionId) return;

            // Lock the button
            spinButton.disabled = true;
            spinButton.textContent = 'SPINNING...';

            // 2. Perform Spin Animation (Client-side, purely visual)
            // A long, random initial spin (e.g., 5 full rotations)
            const initialRotation = 5 * 360; 
            const randomOffset = Math.floor(Math.random() * 360); // Random visual start offset
            spinWheelElement.style.transform = `rotate(${initialRotation + randomOffset}deg)`;
            
            // Wait for the initial visual spin to complete (e.g., 2 seconds)
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            // 3. Get the actual server result for the spin
            const spinActionId = await requestActionId('spinResult'); // Get new ID for result claim
            if (!spinActionId) {
                spinButton.disabled = false;
                spinButton.textContent = 'SPIN';
                return;
            }

            const result = await fetchApi({
                type: 'spinResult',
                user_id: appState.user_id,
                action_id: spinActionId
            });

            if (result.ok) {
                const { actual_prize, prize_index, new_balance, new_spins_count } = result.data;
                
                // Calculate final rotation to land on the correct segment
                // Total rotations (5 full spins) + correction for the prize index
                const rotationToTarget = (5 * 360) + (360 - (prize_index * SEGMENT_ANGLE) - (SEGMENT_ANGLE / 2));
                
                // Apply the final, controlled rotation
                spinWheelElement.style.transition = 'transform 5s cubic-bezier(0.25, 0.1, 0.25, 1)';
                spinWheelElement.style.transform = `rotate(${rotationToTarget}deg)`;

                // Wait for the animation to finish
                await new Promise(resolve => setTimeout(resolve, 5500)); 

                // 4. Update state and UI
                updateState({ 
                    balance: new_balance, 
                    spins_today: new_spins_count 
                });
                
                showCustomAlert('Congratulations!', `You won **${actual_prize} SHIB**!`, 'success');

            } else {
                showCustomAlert('Spin Error', result.error || 'Failed to claim spin reward.', 'error');
            }
            
            // Reset button and wheel for next spin
            spinButton.textContent = 'SPIN';
            updateUI(); // Re-enables button if limit not reached
            spinWheelElement.style.transition = 'none'; // Disable transition for instant reset if needed
        });


        // Withdraw
        withdrawForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const binanceId = document.getElementById('binance-id').value.trim();
            const amount = parseFloat(document.getElementById('withdraw-amount').value);

            if (amount < MIN_WITHDRAW || amount > appState.balance || !binanceId) {
                showCustomAlert('Error', 'Please check your withdrawal amount and Binance ID.', 'error');
                return;
            }
            
            // 1. Get Action ID from the Server ⬅️ تم التفعيل على Withdraw
            const actionId = await requestActionId('withdraw');
            if (!actionId) return;

            // 2. Send withdrawal request via API
            const result = await fetchApi({
                type: 'withdraw',
                user_id: appState.user_id,
                binanceId: binanceId,
                amount: amount,
                action_id: actionId // ⬅️ إرسال Action ID
            });

            if (result.ok) {
                // 3. Update balance with trusted server value
                updateState({ balance: result.data.new_balance });
                
                // 4. Reload withdrawal history with new data
                await loadUserData(); 
                displayWithdrawals(); 
                
                showCustomAlert('Request Sent!', `Details:\nBinance ID: ${binanceId}\nAmount: ${amount.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })} SHIB\n\nThe transfer will be processed within 24 hours.`, 'success');
            }
        });

        // Referral Copy Button
        document.getElementById('copy-referral-link').addEventListener('click', () => {
            const link = document.getElementById('referral-link').textContent;
            navigator.clipboard.writeText(link).then(() => {
                showCustomAlert('Copied', 'Referral link copied to clipboard.', 'success');
            }).catch(err => {
                console.error('Copy failed:', err);
                showCustomAlert('Error', 'Failed to copy link. Please copy manually.', 'error');
            });
        });

        // Task: Join Telegram Channel ⬅️ NEW HANDLER
        joinTelegramButton.addEventListener('click', async () => {
            if (joinTelegramButton.classList.contains('completed-task')) return;

            // 1. Open Telegram Channel link
            window.Telegram.WebApp.openTelegramLink(TELEGRAM_CHANNEL_URL);
            
            // 2. Give the user a moment to join (Optional delay, but better to check immediately after the action)
            // await new Promise(resolve => setTimeout(resolve, 2000));
            
            // 3. Get Action ID from the Server
            const actionId = await requestActionId('completeTask');
            if (!actionId) return;

            // 4. Send server request to claim reward
            const result = await fetchApi({
                type: 'completeTask',
                user_id: appState.user_id,
                action_id: actionId
            });

            if (result.ok) {
                // 5. Update state and UI
                updateState({ 
                    balance: result.data.new_balance, 
                    task_completed: true 
                });
                showCustomAlert('TASK COMPLETED!', `Congratulations, you earned ${result.data.actual_reward} SHIB.`, 'success');
            } else {
                // The server will return an error if the user hasn't joined the channel.
                showCustomAlert('Action Required', result.error || 'Please ensure you have joined the channel and try again.', 'error');
            }
        });

        // Final event listener to ensure background audio starts on the first user interaction
        document.addEventListener('click', function handler() {
            playBGAudio();
            document.removeEventListener('click', handler); // Remove after first successful click
        });
        
        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            // Set up Telegram Web App
            window.Telegram.WebApp.ready();
            window.Telegram.WebApp.expand();
            
            loadUserData();
        });
    </script>
</body>
</html>